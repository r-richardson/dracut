From ab15dac8f40b20da0e45aabf6c8ead55c106a5dd Mon Sep 17 00:00:00 2001
From: Robert Richardson <robert.richardson@suse.com>
Date: Wed, 13 Apr 2022 12:16:31 +0200
Subject: [PATCH] test 60 patch

---
 test/TEST-60-BONDBRIDGEVLANIFCFG/server-init.sh  | 16 ++++++++--------
 test/TEST-60-BONDBRIDGEVLANIFCFG/test.sh         | 10 ++++++----
 .../wait-if-server.sh                            |  8 ++++----
 3 files changed, 18 insertions(+), 16 deletions(-)

diff --git a/test/TEST-60-BONDBRIDGEVLANIFCFG/server-init.sh b/test/TEST-60-BONDBRIDGEVLANIFCFG/server-init.sh
index 5e7e56ef..29c9311a 100755
--- a/test/TEST-60-BONDBRIDGEVLANIFCFG/server-init.sh
+++ b/test/TEST-60-BONDBRIDGEVLANIFCFG/server-init.sh
@@ -54,15 +54,15 @@ udevadm settle
 
 ip link show
 
-wait_for_if_link enx525401123456
-wait_for_if_link enx525401123457
-wait_for_if_link enx525401123458
-wait_for_if_link enx525401123459
+wait_for_if_link eth0
+wait_for_if_link eth1
+wait_for_if_link eth2
+wait_for_if_link eth3
 
-ip link set dev enx525401123456 name net1
-ip link set dev enx525401123457 name net2
-ip link set dev enx525401123458 name net3
-ip link set dev enx525401123459 name net4
+ip link set dev eth0 name net1
+ip link set dev eth1 name net2
+ip link set dev eth2 name net3
+ip link set dev eth3 name net4
 
 modprobe --all -b -q 8021q ipvlan macvlan
 : > /dev/watchdog
diff --git a/test/TEST-60-BONDBRIDGEVLANIFCFG/test.sh b/test/TEST-60-BONDBRIDGEVLANIFCFG/test.sh
index 309600d4..abfe7945 100755
--- a/test/TEST-60-BONDBRIDGEVLANIFCFG/test.sh
+++ b/test/TEST-60-BONDBRIDGEVLANIFCFG/test.sh
@@ -15,8 +15,10 @@ TEST_DESCRIPTION="root filesystem on NFS with bridging/bonding/vlan with $USE_NE
 
 KVERSION=${KVERSION-$(uname -r)}
 
+export basedir=/usr/lib/dracut
+
 # Uncomment this to debug failures
-#DEBUGFAIL="rd.shell rd.break"
+DEBUGFAIL="rd.shell rd.break"
 #DEBUGFAIL="rd.shell rd.break rd.debug"
 #SERIAL="tcp:127.0.0.1:9999"
 
@@ -36,7 +38,7 @@ run_server() {
         -hda "$TESTDIR"/server.ext3 \
         -serial "${SERIAL:-"file:$TESTDIR/server.log"}" \
         -watchdog i6300esb -watchdog-action poweroff \
-        -append "panic=1 oops=panic softlockup_panic=1 loglevel=7 root=LABEL=dracut rootfstype=ext3 rw console=ttyS0,115200n81 selinux=0 rd.debug" \
+        -append "nompath panic=1 oops=panic softlockup_panic=1 loglevel=7 root=LABEL=dracut rootfstype=ext3 rw console=ttyS0,115200n81 selinux=0 rd.debug" \
         -initrd "$TESTDIR"/initramfs.server \
         -pidfile "$TESTDIR"/server.pid -daemonize || return 1
     chmod 644 -- "$TESTDIR"/server.pid || return 1
@@ -92,7 +94,7 @@ client_test() {
         -hda "$TESTDIR"/client.img \
         -watchdog i6300esb -watchdog-action poweroff \
         -append "
-        panic=1 oops=panic softlockup_panic=1
+        nompath panic=1 oops=panic softlockup_panic=1
         ifname=net1:52:54:00:12:34:01
         ifname=net2:52:54:00:12:34:02
         ifname=net3:52:54:00:12:34:03
@@ -403,4 +405,4 @@ test_cleanup() {
 }
 
 # shellcheck disable=SC1090
-. "$testdir"/test-functions
+. "$basedir"/test/test-functions
diff --git a/test/TEST-60-BONDBRIDGEVLANIFCFG/wait-if-server.sh b/test/TEST-60-BONDBRIDGEVLANIFCFG/wait-if-server.sh
index 7cdb9417..189ddff4 100644
--- a/test/TEST-60-BONDBRIDGEVLANIFCFG/wait-if-server.sh
+++ b/test/TEST-60-BONDBRIDGEVLANIFCFG/wait-if-server.sh
@@ -1,6 +1,6 @@
 #!/bin/sh
 . /lib/net-lib.sh
-wait_for_if_link enx525401123456
-wait_for_if_link enx525401123457
-wait_for_if_link enx525401123458
-wait_for_if_link enx525401123459
+wait_for_if_link eth0
+wait_for_if_link eth1
+wait_for_if_link eth2
+wait_for_if_link eth3
-- 
2.37.1

